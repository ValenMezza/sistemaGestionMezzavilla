<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= (typeof title !== 'undefined' && title) ? title : 'Clientes' %></title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <div class="nav">
    <div class="nav__inner">
      <a class="brand" href="/home">
        <span class="brand__dot"></span>
        <span>Sistemas Mezzavilla</span>
      </a>

      <% if (user) { %>
        <div class="nav__links">
          <a class="btn btn--ghost" href="/cantera">Cantera</a>
          <a class="btn btn--ghost" href="/viajes">Viajes</a>
          <a class="btn btn--ghost" href="/stock">Stock</a>
          <a class="btn btn--ghost" href="/clientes">Clientes</a>
        </div>

        <div class="nav__right">
          <span class="small">ğŸ‘¤ <%= user.username %></span>
          <form method="POST" action="/logout">
            <button class="btn btn--danger" type="submit">Salir</button>
          </form>
        </div>
      <% } else { %>
        <div class="nav__right" style="margin-left:auto;">
          <a class="btn btn--primary" href="/login">Ingresar</a>
        </div>
      <% } %>
    </div>
  </div>

  <div class="container">
    <div class="row row--space">
      <h1>Clientes</h1>
      <a class="btn btn--primary" href="/clientes/nuevo">Nuevo cliente</a>
    </div>


<div class="card" style="margin-bottom:14px;">
  <form method="GET" action="/clientes" class="row" style="gap:12px; align-items:end;">
    <div style="min-width:260px;">
      <label>Buscar</label>
      <input name="q" value="<%= q || '' %>" placeholder="Nombre o telÃ©fono" />
    </div>

    <div style="display:flex; align-items:center; gap:8px;">
      <label style="display:flex; gap:8px; align-items:center; margin:0;">
        <input type="checkbox" name="conDeuda" value="true" <%= conDeuda ? 'checked' : '' %>>
        Solo con deuda
      </label>
    </div>

    <button class="btn btn--ghost" type="submit">Aplicar</button>
    <a class="btn btn--ghost" href="/clientes">Limpiar</a>
  </form>
</div>

    <% if (!clients || clients.length === 0) { %>
      <div class="card">
        <p>No hay clientes cargados.</p>
      </div>
    <% } else { %>
      <table class="table">
        <thead>
          <tr>
            <th>Nombre completo</th>
            <th>TelÃ©fono</th>
            <th>Deuda</th>
            <th style="width: 220px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% clients.forEach(c => { %>
            <tr>
              <td><%= c.full_name %></td>
              <td><%= c.phone || '-' %></td>
              <td>$<%= Number(c.debt || 0).toFixed(2) %></td>
              
<td class="actions">
  <a class="icon-btn" href="/clientes/<%= c.id %>/editar" title="Editar">
    âœï¸
  </a>
  <a class="icon-btn" href="/clientes/<%= c.id %>/pdf/mensual" title="PDF mensual">
    ğŸ“„<span class="mini">M</span>
  </a>
  <a class="icon-btn" href="/clientes/<%= c.id %>/pdf/semanal" title="PDF semanal">
    ğŸ“„<span class="mini">S</span>
  </a>

  <button class="icon-btn" type="button" data-pay-toggle="<%= c.id %>" title="Registrar pago / Saldar deuda">
    ğŸ’°
  </button>

  <form method="POST"
        action="/clientes/<%= c.id %>/eliminar"
        style="display:inline;"
        onsubmit="return confirm('Â¿Eliminar este cliente?');">
    <button class="icon-btn danger" type="submit" title="Eliminar">ğŸ—‘ï¸</button>
  </form>
</td>
            
  </tr>
  <tr id="pay-row-<%= c.id %>" class="pay-row" style="display:none;">
    <td colspan="4">
      <form class="pay-form" action="/clientes/<%= c.id %>/pagos" method="POST">
        <label class="small">Registrar pago</label>
        <input type="number" step="0.01" name="amount" placeholder="Monto" required>
        <select name="method">
          <option value="EFECTIVO">Efectivo</option>
          <option value="TRANSFERENCIA">Transferencia</option>
        </select>
        <button class="btn btn--primary btn--sm" type="submit">Guardar</button>
        <button class="btn btn--ghost btn--sm" type="button" data-pay-cancel="<%= c.id %>">Cancelar</button>
      </form>
    </td>
  </tr>
<% }) %>
        </tbody>
      </table>
    <% } %>
  </div>

  <div class="footer">
    <div class="small">Sistema interno â€” versiÃ³n sin DB (memoria). Listo para migrar a PostgreSQL.</div>
  </div>
  <script src="/js/clientes.js"></script>
</body>
</html>
