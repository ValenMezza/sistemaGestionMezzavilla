<!DOCTYPE html>
<html lang="es">
<%- include('../partials/head', { title: 'Cantera - Semanal' }) %>
<body>
  <%- include('../partials/nav') %>

  <div class="container">
    <h1>Cantera - Resúmenes semanales</h1>

    <div class="card">
      <h2>Seleccionar mes, semana y cliente (opcional)</h2>

      <form method="GET" action="/cantera/semanal" class="row">
        <input type="hidden" name="year" value="<%= year %>"/>

        <div style="min-width:220px;">
          <label>Mes</label>
          <select name="month" onchange="this.form.submit()">
            <% months.forEach(m => { %>
              <option value="<%= m.value %>" <%= Number(month)===Number(m.value) ? 'selected' : '' %>><%= m.label %></option>
            <% }) %>
          </select>
        </div>

        <div style="min-width:340px;">
          <label>Semana (Lunes a Domingo)</label>
          <select name="weekStart" onchange="this.form.submit()">
            <option value="">-- Elegir semana --</option>
            <% weeks.forEach(w => { %>
              <option value="<%= w.weekStart %>" <%= weekStart===w.weekStart ? 'selected' : '' %>><%= w.label %></option>
            <% }) %>
          </select>
        </div>

        <div style="min-width:260px;">
          <label>Cliente (opcional)</label>
          <select name="clientId" onchange="this.form.submit()">
            <option value="">-- Todos --</option>
            <% clients.forEach(c => { %>
              <option value="<%= c.id %>" <%= String(clientId)===String(c.id) ? 'selected' : '' %>><%= c.full_name %></option>
            <% }) %>
          </select>

<div style="min-width:260px;">
  <label>Producto (opcional)</label>
  <select name="productId" onchange="this.form.submit()">
    <option value="">-- Todos --</option>
    <% products.forEach(p => { %>
      <option value="<%= p.id %>" <%= String(productId)===String(p.id) ? 'selected' : '' %>><%= p.name %></option>
    <% }) %>
  </select>
</div>

<div style="min-width:220px;">
  <label>Método de pago (opcional)</label>
  <select name="paymentMethod" onchange="this.form.submit()">
    <option value="">-- Todos --</option>
    <option value="efectivo" <%= paymentMethod==='efectivo' ? 'selected' : '' %>>Efectivo</option>
    <option value="transferencia" <%= paymentMethod==='transferencia' ? 'selected' : '' %>>Transferencia</option>
    <option value="vales" <%= paymentMethod==='vales' ? 'selected' : '' %>>Vales</option>
    <option value="fiado" <%= paymentMethod==='fiado' ? 'selected' : '' %>>Fiado</option>
  </select>
</div>

<div style="min-width:170px; display:flex; align-items:end;">
  <label style="display:flex; gap:8px; align-items:center; margin:0;">
    <input type="checkbox" name="conDeuda" <%= (conDeuda==='on' || conDeuda==='true') ? 'checked' : '' %> onchange="this.form.submit()">
    Con deuda
  </label>
</div>

        </div>
      </form>
    </div>

    <% if (dashboard) { %>
      <div class="card">
        <h2>Resumen semanal</h2>
        <div class="row" style="margin-top:10px; gap:10px;">
          <a class="btn btn--ghost" href="/cantera/semanal/pdf?year=<%= year %>&month=<%= month %>&weekStart=<%= weekStart %>&clientId=<%= clientId %>&productId=<%= productId %>&paymentMethod=<%= paymentMethod %>&conDeuda=<%= conDeuda %>">Exportar PDF (Semana)</a>
        </div>
        <p><b>Semana:</b> <%= weekStart %> al <%= weekEnd %></p>
        <% if (clientId) { %>
          <p><b>Cliente:</b> <%= clients.find(x=>String(x.id)===String(clientId))?.full_name || 'Seleccionado' %></p>
        <% } %>
        <p><b>Ventas:</b> <%= dashboard.sales_count %></p>
        <p><b>Cobrado:</b> Efectivo $<%= dashboard.saldo_cobrado_efectivo.toFixed(2) %> | Transferencia $<%= dashboard.saldo_cobrado_transferencia.toFixed(2) %></p>
        <p><b>A cobrar (fiado/vales):</b> $<%= dashboard.saldo_a_cobrar.toFixed(2) %></p>
        <p><b>Ventas con deuda:</b> <%= dashboard.ventas_con_deuda %></p>
      </div>

      <div class="card">
        <h2>Días de la semana</h2>
        <div class="grid">
          <% days.forEach(d => { %>
            <a class="card card--link"
               href="/cantera/resumen/dia?date=<%= d.date %>&clientId=<%= clientId || '' %>&weekStart=<%= weekStart %>&month=<%= month %>&year=<%= year %>">
               <%= d.label %>
            </a>
          <% }) %>
        </div>
      </div>

      <div class="card">
        <h2>Ventas de la semana</h2>

        <% if (!salesList.length) { %>
          <p>No hay ventas en esta semana.</p>
        <% } %>

        <% salesList.forEach(s => { %>
          <div class="sale">
            <div class="sale__top">
              <div>
                <b><%= s.dayISO %> <%= s.time %></b>
                <span> | <%= s.client_name %></span>
                <span class="muted"> | <%= s.product_name || '' %></span>
              </div>
              <span class="badge"><%= s.payment_method %></span>
            </div>

            <div class="sale__mid">
              <span>Cant: <%= Number(s.qty || 1) %></span>
              <span>Unit: $<%= Number(s.product_price || 0).toFixed(2) %></span>
              <span>Total: $<%= Number(s.final_price || 0).toFixed(2) %></span>
              <span>Deuda: $<%= Number(s.debt || 0).toFixed(2) %></span>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>

    <div class="row">
      <a class="btn" href="/cantera/vender">Venta rápida</a>
      <a class="btn btn--ghost" href="/cantera">Volver</a>
    </div>
  </div>

  <%- include('../partials/footer') %>
</body>
</html>
